<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¬¢è¿è‡´è¾-äº¤äº’ç§»åŠ¨ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: sans-serif; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #hint { position: absolute; bottom: 10%; width: 100%; text-align: center; color: #d4af37; font-size: 16px; padding: 0 20px; box-sizing: border-box; text-shadow: 0 0 10px rgba(212,175,55,0.8); }
        
        /* æ‰‹æœºç«¯é¢„è§ˆçª—ä¼˜åŒ– */
        #webcam-wrapper { position: absolute; top: 10px; right: 10px; width: 80px; height: 110px; border: 1px solid #d4af37; border-radius: 4px; overflow: hidden; background: #000; opacity: 0.7; }
        #webcam { width: 100%; height: 100%; transform: scaleX(-1); object-fit: cover; }
        
        /* å¯åŠ¨é®ç½©ï¼šæ‰‹æœºç«¯å¿…é¡»ç‚¹å‡»æ‰èƒ½å¼€å¯åŠŸèƒ½ */
        #loader { 
            position: absolute; width: 100%; height: 100%; background: #020205; 
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #d4af37; cursor: pointer;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(212,175,55,0.3); border-top: 3px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #btn-start { margin-top: 20px; padding: 10px 20px; border: 1px solid #d4af37; color: #d4af37; background: transparent; border-radius: 20px; display: none;}
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div id="load-text">èµ„æºè½½å…¥ä¸­...</div>
        <button id="btn-start">ç‚¹å‡»å¼€å¯æ„Ÿåº”</button>
    </div>
    
    <div id="canvas-container"></div>
    <div id="ui-layer">
        <div id="hint">ğŸ–ï¸ ä¼¸æŒ:æ¬¢è¿ | âœŠ æ¡æ‹³:æ¯”å¿ƒ | âœŒï¸ è€¶:æ•£å¼€<br>(æ‰‹æœºç«¯ä¹Ÿå¯ç‚¹å‡»å±å¹•åˆ‡æ¢)</div>
    </div>
    
    <div id="webcam-wrapper">
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // æ‰‹æœºç«¯å‡å°‘ç²’å­æ•°é‡ä»¥ä¿è¯æµç•…
        const P_COUNT = 2200; 
        let scene, camera, renderer, composer, handLandmarker, video;
        let particles = [];
        let state = 'SCATTER'; 
        const states = ['SCATTER', 'TEXT', 'HEART'];
        let stateIdx = 0;
        const pointsText = [];
        const pointsHeart = [];

        async function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 70;

            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio > 1 ? 1.5 : 1);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const renderPass = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.8, 0.3, 0.9);
            composer = new EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);

            await generateTextPoints("æ¬¢è¿å„ä½è€å¸ˆè…ä¸´å¬è¯¾");
            generateHeartPoints();

            const geo = new THREE.PlaneGeometry(0.5, 0.5);
            const matGold = new THREE.MeshBasicMaterial({ color: 0xffd700, transparent: true, opacity: 0.8 });
            const matRed = new THREE.MeshBasicMaterial({ color: 0xff4400, transparent: true, opacity: 0.9 });

            for (let i = 0; i < P_COUNT; i++) {
                const mesh = new THREE.Mesh(geo, i % 7 === 0 ? matRed : matGold);
                scene.add(mesh);
                particles.push({
                    mesh: mesh,
                    scatter: new THREE.Vector3((Math.random()-0.5)*130, (Math.random()-0.5)*150, (Math.random()-0.5)*50),
                    target: new THREE.Vector3()
                });
            }

            // é¢„åŠ è½½æ¨¡å‹ï¼Œä½†ä¸å¯åŠ¨æ‘„åƒå¤´
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: { 
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                        delegate: "GPU" 
                    },
                    runningMode: "VIDEO", numHands: 1
                });
                document.getElementById('load-text').innerText = "å·²å°±ç»ª";
                document.querySelector('.spinner').style.display = 'none';
                document.getElementById('btn-start').style.display = 'block';
            } catch (e) {
                document.getElementById('load-text').innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
            }

            // ç›‘å¬ç‚¹å‡»å¯åŠ¨
            document.getElementById('loader').onclick = startApp;
            // æ‰‹æœºç«¯ç‚¹å‡»å±å¹•åˆ‡æ¢çŠ¶æ€ï¼ˆè¾…åŠ©ï¼‰
            window.addEventListener('touchstart', () => {
                stateIdx = (stateIdx + 1) % states.length;
                state = states[stateIdx];
            });
        }

        async function startApp() {
            video = document.getElementById('webcam');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: 240, height: 320 } 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    document.getElementById('loader').style.display = 'none';
                    animate();
                };
            } catch (err) {
                document.getElementById('loader').style.display = 'none';
                animate(); // å³ä½¿æ²¡æ‘„åƒå¤´ä¹Ÿè¿è¡Œï¼Œæ”¯æŒç‚¹å‡»åˆ‡æ¢
            }
        }

        async function generateTextPoints(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1000; canvas.height = 400;
            ctx.fillStyle = 'white';
            ctx.font = 'bold 80px sans-serif'; // æ‰‹æœºç«¯ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç²—ä½“
            ctx.textAlign = 'center';
            ctx.fillText(text, 500, 200);

            const data = ctx.getImageData(0, 0, 1000, 400).data;
            for (let y = 0; y < 400; y += 5) { // å¢åŠ é‡‡æ ·æ­¥é•¿æé«˜æ€§èƒ½
                for (let x = 0; x < 1000; x += 5) {
                    if (data[(y * 1000 + x) * 4] > 128) {
                        pointsText.push(new THREE.Vector3((x - 500) * 0.15, -(y - 200) * 0.15, 0));
                    }
                }
            }
        }

        function generateHeartPoints() {
            for (let i = 0; i < P_COUNT; i++) {
                const t = Math.random() * Math.PI * 2;
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                pointsHeart.push(new THREE.Vector3(x * 1.2, y * 1.2, (Math.random()-0.5)*10));
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (video && video.readyState >= 2) {
                const results = handLandmarker.detectForVideo(video, performance.now());
                if (results.landmarks && results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    const extended = [8, 12, 16, 20].filter(id => lm[id].y < lm[id-2].y).length;
                    state = extended <= 1 ? 'HEART' : (extended >= 4 ? 'TEXT' : 'SCATTER');
                }
            }

            const time = Date.now() * 0.002;
            const lerpFactor = 0.08;

            particles.forEach((p, i) => {
                let target;
                if (state === 'TEXT') target = pointsText[i % pointsText.length];
                else if (state === 'HEART') target = pointsHeart[i % pointsHeart.length];
                else target = p.scatter;

                p.mesh.position.lerp(target, lerpFactor);
                p.mesh.lookAt(camera.position); // ç²’å­å§‹ç»ˆé¢å‘å±å¹•
            });

            composer.render();
        }

        init();
    </script>
</body>
</html>
