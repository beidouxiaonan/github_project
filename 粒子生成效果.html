<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¬¢è¿è‡´è¾-æ‰‹æœºå…¼å®¹ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        /* æƒé™æç¤ºé®ç½© */
        #permission-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #d4af37; text-align: center; padding: 20px;
        }
        #start-btn {
            padding: 15px 40px; font-size: 18px; background: #d4af37; color: #000;
            border: none; border-radius: 30px; margin-top: 20px; font-weight: bold;
        }
        #webcam-view {
            position: absolute; top: 10px; right: 10px; width: 80px; height: 100px;
            border: 1px solid #d4af37; z-index: 50; border-radius: 8px; transform: scaleX(-1);
        }
        #hint-text {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            color: #d4af37; z-index: 20; pointer-events: none; font-size: 14px;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>
</head>
<body>

<div id="permission-overlay">
    <h2>æ¬¢è¿è…ä¸´å¬è¯¾</h2>
    <p>äº¤äº’æ¼”ç¤ºéœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œæ‰‹åŠ¿æ„Ÿåº”</p>
    <p style="font-size: 12px; color: #666;">(è¯·ç¡®ä¿åœ°å€æ ä¸º HTTPS åè®®)</p>
    <button id="start-btn">ç‚¹å‡»æˆæƒå¹¶å¼€å¯</button>
</div>

<div id="hint-text">ğŸ–ï¸ ä¼¸æŒ: æ¬¢è¿ | âœŠ æ¡æ‹³: æ¯”å¿ƒ | âœŒï¸ è€¶: æ•£å¼€</div>
<video id="webcam-view" autoplay playsinline muted></video>
<div id="container"></div>

<script type="module">
    import * as THREE from 'three';
    import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

    let handLandmarker;
    let video = document.getElementById('webcam-view');
    let currentState = 'SCATTER';

    // åˆå§‹åŒ–æ‰‹åŠ¿æ£€æµ‹å™¨
    async function initMP() {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
        handLandmarker = await HandLandmarker.createFromOptions(vision, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                delegate: "GPU"
            },
            runningMode: "VIDEO", numHands: 1
        });
    }

    // æ ¸å¿ƒå¯åŠ¨å‡½æ•°ï¼šç”±ç‚¹å‡»è§¦å‘
    async function requestCamera() {
        document.getElementById('start-btn').innerText = "å¯åŠ¨ä¸­...";
        try {
            const constraints = {
                video: {
                    facingMode: "user",
                    width: { ideal: 480 },
                    height: { ideal: 640 }
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            await initMP();
            
            document.getElementById('permission-overlay').style.display = 'none';
            startThreeJS(); // å¯åŠ¨3Dåœºæ™¯
        } catch (err) {
            console.error(err);
            alert("æ— æ³•è·å–æ‘„åƒå¤´æƒé™ã€‚è¯·ç¡®ä¿ï¼š\n1. ä½¿ç”¨äº† HTTPS ç¯å¢ƒ\n2. åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸äº†æ‘„åƒå¤´æƒé™");
            document.getElementById('start-btn').innerText = "ç‚¹å‡»é‡è¯•";
        }
    }

    document.getElementById('start-btn').onclick = requestCamera;

    // --- Three.js éƒ¨åˆ†ï¼ˆç®€åŒ–ç‰ˆä»¥é€‚é…æ‰‹æœºï¼‰ ---
    function startThreeJS() {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 50;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('container').appendChild(renderer.domElement);

        // ç²’å­ç³»ç»Ÿ... (é€»è¾‘åŒä¸Šï¼Œç•¥ä½œç®€åŒ–ä¿è¯æµç•…)
        const particles = [];
        const group = new THREE.Group();
        scene.add(group);

        // ç”Ÿæˆç²’å­é€»è¾‘ (æ­¤å¤„ä¸ºäº†ç®€æ´ç›´æ¥ä½¿ç”¨ç®€å•çƒä½“ç²’å­)
        const geometry = new THREE.SphereGeometry(0.2, 8, 8);
        const material = new THREE.MeshBasicMaterial({ color: 0xd4af37 });

        for(let i=0; i<1500; i++) {
            const p = new THREE.Mesh(geometry, material);
            p.position.set((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*50);
            group.add(p);
            particles.push({
                mesh: p,
                origin: p.position.clone()
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (video.readyState >= 2) {
                const results = handLandmarker.detectForVideo(video, performance.now());
                if (results.landmarks && results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    // åˆ¤æ–­æ‰‹åŠ¿ï¼šé£ŸæŒ‡å°– y åæ ‡æ˜¯å¦é«˜äºé£ŸæŒ‡æ ¹éƒ¨
                    const isExtended = lm[8].y < lm[6].y && lm[12].y < lm[10].y;
                    currentState = isExtended ? 'TEXT' : 'HEART';
                }
            }

            // ç²’å­æ ¹æ® currentState æ‰§è¡Œç®€å•çš„åŠ¨ç”»å˜æ¢
            particles.forEach(p => {
                // å…·ä½“çš„ç²’å­ä½ç½®å˜æ¢é€»è¾‘...
            });

            renderer.render(scene, camera);
        }
        animate();
    }
</script>
</body>
</html>
